# Using Metasploit

## Initial Recon / Discovery&#x20;

### Find MSSQL Servers&#x20;

```
use auxiliary/scanner/mssql/mssql_ping
```

<figure><img src="../../../.gitbook/assets/image (10) (1).png" alt=""><figcaption></figcaption></figure>

### Fingerprint MSSQL&#x20;

```
use auxiliary/scanner/mssql/mssql_version
```

<figure><img src="../../../.gitbook/assets/image (9) (1) (1).png" alt=""><figcaption></figcaption></figure>

_Microsoft SQL Server version 15.0.2000 corresponds to the initial Release to Manufacturing (RTM) build of **Microsoft SQL Server 2019**, released around November 2019._

## Enumeration&#x20;

### Brute-Force&#x20;

#### **With Option (`USE_WINDOWS_AUTHENT`) set**

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### **With Option (`USE_WINDOWS_AUTHENT`) unset**

<figure><img src="../../../.gitbook/assets/2026-02-08_133117.png" alt=""><figcaption></figcaption></figure>

## Credentialed-Enumeration&#x20;

### Enumerate MSSQL Internals

{% code overflow="wrap" %}
```shellscript
msf6 auxiliary(admin/mssql/mssql_enum) > run
[*] Running MS SQL Server Enumeration...
[*] Using existing session 2
[*] Version:
[*]     Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64) 
[*]             Sep 24 2019 13:48:23 
[*]             Copyright (C) 2019 Microsoft Corporation
[*]             Express Edition (64-bit) on Windows Server 2019 Datacenter Evaluation 10.0 <X64> (Build 17763: ) (Hypervisor)
[*] Configuration Parameters:
[*]     C2 Audit Mode is Not Enabled
[*]     xp_cmdshell is Enabled
[*]     remote access is Enabled
[*]     allow updates is Not Enabled
[*]     Database Mail XPs is Not Enabled
[*]     Ole Automation Procedures are Enabled
[*] Databases on the server:
[*]     Database name:master
[*]     Database Files for master:
[*]             C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\master.mdf
[*]             C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\mastlog.ldf
[*]     Database name:tempdb
[*]     Database Files for tempdb:
[*]             C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\tempdb.mdf
[*]             C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\templog.ldf
[*]     Database name:model
[*]     Database Files for model:
[*]     Database name:msdb
[*]     Database Files for msdb:
[*]             C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\MSDBData.mdf
[*]             C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\MSDBLog.ldf
[*]     Database name:sqluserdb
[*]     Database Files for sqluserdb:
[*]     Database name:sqladmindb
[*]     Database Files for sqladmindb:
[*] System Logins on this Server:
[*]     sa
[*]     BUILTIN\Users
[*]     backontrack\sqluser
[*]     backontrack\sqladmin
[*] Disabled Accounts:
[*]     No Disabled Logins Found
[*] No Accounts Policy is set for:
[*]     sa
[*] Password Expiration is not checked for:
[*]     sa
[*] System Admin Logins on this Server:
[*]     sa
[*] Windows Logins on this Server:
[*]     backontrack\sqluser
[*]     backontrack\sqladmin
[*] Windows Groups that can logins on this Server:
[*]     BUILTIN\Users
[*] Accounts with Username and Password being the same:
[*]     No Account with its password being the same as its username was found.
[*] Accounts with empty password:
[*]     No Accounts with empty passwords where found.
[*] Stored Procedures with Public Execute Permission found:
[*]     sp_replsetsyncstatus
[*]     sp_replcounters
[*]     sp_replsendtoqueue
[*]     sp_resyncexecutesql
[*]     sp_prepexecrpc
[*]     sp_repltrans
[*]     sp_xml_preparedocument
[*]     xp_qv
[*]     xp_getnetname
[*]     sp_releaseschemalock
[*]     sp_refreshview
[*]     sp_replcmds
[*]     sp_unprepare
[*]     sp_resyncprepare
[*]     sp_createorphan
[*]     xp_dirtree
[*]     sp_replwritetovarbin
[*]     sp_replsetoriginator
[*]     sp_xml_removedocument
[*]     sp_repldone
[*]     sp_reset_connection
[*]     xp_fileexist
[*]     xp_fixeddrives
[*]     sp_getschemalock
[*]     sp_prepexec
[*]     xp_revokelogin
[*]     sp_execute_external_script
[*]     sp_resyncuniquetable
[*]     sp_replflush
[*]     sp_resyncexecute
[*]     xp_grantlogin
[*]     sp_droporphans
[*]     xp_regread
[*]     sp_getbindtoken
[*]     sp_replincrementlsn
[*] Instances found on this server:
[*] Default Server Instance SQL Server Service is running under the privilege of:
[*]     NT Service\MSSQLSERVER
[*] Auxiliary module execution completed

```
{% endcode %}

## Exploitation&#x20;

### Exploit UNC Path Injection&#x20;

#### Start SMB Server&#x20;

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

#### Exploit

```shellscript
use auxiliary/admin/mssql/mssql_ntlm_stealer
```

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
_Note the difference between hashdump and mssql\_ntlm\_stealer._
{% endhint %}

### Exploit Impersonation&#x20;

<figure><img src="../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

## Execute Commands&#x20;

### Using xp\_cmdshell

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

### Using OLE Automation Procedures&#x20;

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

## Post-Exploitation&#x20;

<figure><img src="../../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>
