# Using PowerUpSQL

## Recon

### **Discover SQL Server Instances**&#x20;

{% code overflow="wrap" %}
```powershell
# Both the command provides information about instances 
Get-SQLInstanceLocal
Get-SQLInstanceDomain 
## This command give SPN information which is further helpful for kerberoasting.
## Some instance may not be registered with AD. It is visible in Get-SQLInstanceLocal
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (298).png" alt=""><figcaption></figcaption></figure>

Connectivity testing is crucial because not all discovered instances may be accessible (e.g., due to firewalls, auth issues, or the service being down).

### Check accessibility of instances&#x20;

<figure><img src="../../../.gitbook/assets/image (299).png" alt=""><figcaption></figcaption></figure>

## Enumeration

### Gather Basic Server Information&#x20;

{% code overflow="wrap" %}
```powershell
Get-SQLServerInfo -Instance <instance name>
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (300).png" alt=""><figcaption></figcaption></figure>

Retrieves core server metadata like version, patch level, OS, and auth mode. This is basic enumeration to fingerprint the target. More important term is `IsSysadmin` term. If it is yes then we can use it further for privilege escalation or further exploitation.&#x20;

### Gather Database information&#x20;

{% code overflow="wrap" %}
```powershell
Get-SQLDatabase -Instance <instance name> | Select-Object Instance,DatabaseName,DatabaseOwner
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (301).png" alt=""><figcaption></figcaption></figure>

## Credentialed Enumeration&#x20;

### List Server Logins&#x20;

{% code overflow="wrap" %}
```powershell
Get-SQLServerLogin | Select-Object Instance,PrincipalName

Get-SQLServerLogin -Instance <instance> -Username <username> -Password <password> | Select-Object Instance,Principalname
## Note that the username and password must be supplied of SQL authentication. Windows auth can't work in this fields.
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (302).png" alt=""><figcaption></figcaption></figure>

We can see the difference in result above because of the ownership. The terminal in black is executed as sqluser. That's why we can see other login that actually exists in the DBSRV01 instance. The ManagementSQL instance is owned by the `r0b` thus it gives correct listing in blue terminal. Thus we're able to get list of logins if one of the user actually has login to that instance available.&#x20;

<figure><img src="../../../.gitbook/assets/image (303).png" alt=""><figcaption></figcaption></figure>

### List server config settings essential for post-exploitation

{% code overflow="wrap" %}
```powershell
Get-SQLServerConfiguration | Where-Object {$_.Name -match "xp_cmdshell|Ole Automation|clr enabled|external scripts|Agent XPs|Database Mail|Ad Hoc Distributed Queries|remote access|remote admin|cross db ownership|contained database|filesystem|SMO and DMO|user instances"} | Select-Object Instance, Name, config_value
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (304).png" alt=""><figcaption></figcaption></figure>

In above result we need to manually check for various things. Instead of this use the below commands which instantly highlights actual risk.

{% code overflow="wrap" %}
```powershell
Get-SQLServerConfiguration -Instance "DBSRV01\ManagementSQL" | Where-Object {$_.config_value -eq 1 -and $_.Name -match "xp_cmdshell|Ole Automation|clr enabled|external scripts|Agent XPs|Database Mail|Ad Hoc Distributed Queries|remote access|remote admin|cross db ownership|contained database|filesystem|SMO and DMO|user instances"} | Select-Object Instance, Name, config_value
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (305).png" alt=""><figcaption></figcaption></figure>

### Check if the current user is sysadmin

```powershell
Get-SQLSysadminCheck

Get-SQLSysadminCheck -Instance <instance> 

Get-SQLSysadminCheck -Instance <instance> -Username user -Password pass
```

<figure><img src="../../../.gitbook/assets/image (308).png" alt=""><figcaption></figcaption></figure>

This is also visible in `Get-SQLServerInfo`.&#x20;

### List server-level privileges for login&#x20;

<figure><img src="../../../.gitbook/assets/image (309).png" alt=""><figcaption></figcaption></figure>

**What to look for:**&#x20;

1. `Impersonate` -> privilege-escalation potential&#x20;
   1. Chained impersonation is possible.&#x20;
2.
