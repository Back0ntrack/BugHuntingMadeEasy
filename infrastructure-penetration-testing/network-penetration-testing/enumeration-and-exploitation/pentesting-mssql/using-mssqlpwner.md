# Using mssqlpwner

## Enumeration&#x20;

### All is well ðŸ˜…

```bash
mssqlpwner backontrack.local/sqluser:'S@$$w0rd'@192.168.16.135 -windows-auth enumerate
```

<figure><img src="../../../../.gitbook/assets/image (349).png" alt=""><figcaption></figcaption></figure>

### Information it retrieved&#x20;

* **Connection & environment details**
  * Successfully connected to MSSQL server at 192.168.16.135 over port 1433 using TLS encryption
  * Authenticated as domain user `backontrack\sqluser` with Windows authentication
  * Default database context: `master`
  * Language setting: `us_english`
  * Packet size negotiated: 16192
  * Target hostname discovered: `DBSRV01`
* **SQL Server instance information**
  * SQL Server version: Microsoft SQL Server 2019 (RTM) 15.0.2000.5 (X64)
  * Edition: Express Edition (64-bit)
  * OS: Windows Server 2019 Datacenter Evaluation (Build 17763)
  * Instance name: MSSQLSERVER
  * Domain name: BACKONTRACK
* **Discovered server principals (logins)**
  * `sa`
  * `backontrack\sqladmin`
  * `backontrack\sqluser`
  * `BACKONTRACK\Administrator`
* **Discovered database principals (users)**
  * `backontrack\sqluser`
  * `backontrack\sqladmin`
* **Privilege escalation / impersonation paths**
  * User can impersonate: `sa`, `backontrack\sqladmin`, `BACKONTRACK\Administrator`
  * Multiple chained impersonation paths identified between principals
  * Successful privilege chaining up to `sa` and domain Administrator context
  * Some privilege chains already existed and were reused
* **Roles and permissions**
  * User is member of server role: `sysadmin`
  * User is member of database role: `db_owner`
  * Full administrative privileges available via impersonation
* **Database enumeration**
  * Available databases: `sqladmindb`, `sqluserdb`, `testdb`, `test_trustworthy`, `trustdatabase`
  * Trustworthy databases: `msdb`, `trustdatabase`, `testdb`, `test_trustworthy`
* **Linked server discovery**
  * Linked server: `DBSRV01` (local server with multiple privilege chains)
  * Linked server: `DC01` (remote server discovered through chaining)
  * Remote hostname discovered: `DC01`
* **Access on linked server DC01**
  * Access obtained as `sa` and `BACKONTRACK\Administrator`
  * User has `sysadmin` server role on DC01
  * User has `db_owner` role on DC01 master database
  * Trustworthy database on DC01: `msdb`

{% hint style="info" %}
_Need to feed resource to chatgpt for understanding. too noisy result._&#x20;
{% endhint %}

### Get Linked Server List&#x20;

{% code overflow="wrap" %}
```bash
mssqlpwner backontrack.local/sqluser:'S@$$w0rd'@192.168.16.135 -windows-auth get-link-server-list
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (351).png" alt=""><figcaption></figcaption></figure>

## Exploit UNC Path Injection&#x20;

### Start the listener

<figure><img src="../../../../.gitbook/assets/image (353).png" alt=""><figcaption></figcaption></figure>

### Exploit The vuln

<figure><img src="../../../../.gitbook/assets/image (354).png" alt=""><figcaption></figcaption></figure>

### Got the Hash&#x20;

<figure><img src="../../../../.gitbook/assets/image (355).png" alt=""><figcaption></figcaption></figure>

## Exploiting UNC Path Injection on Linked Server

### Exploit the vuln

<figure><img src="../../../../.gitbook/assets/image (356).png" alt=""><figcaption></figcaption></figure>

### Got the Hash&#x20;

<figure><img src="../../../../.gitbook/assets/image (357).png" alt=""><figcaption></figcaption></figure>

## Execute Commands&#x20;

**It will try to do everything it can to execute commands.**&#x20;

{% hint style="info" %}
_Interactive mode is great._&#x20;
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (352).png" alt=""><figcaption></figcaption></figure>

## Execute commands on linked server&#x20;

```
set-link-server DC01

exec ipconfig
```

<figure><img src="../../../../.gitbook/assets/image (358).png" alt=""><figcaption></figcaption></figure>
